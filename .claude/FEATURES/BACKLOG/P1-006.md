# P1-006: Configuration Apple Sign-In

| Attribut | Valeur |
|----------|--------|
| **ID** | P1-006 |
| **Titre** | Configuration Apple Sign-In |
| **Priorite** | P2 - Normal |
| **Statut** | A faire |
| **Phase** | 1 - Setup & Core |
| **Dependances** | P1-005 (Auth), Compte Apple Developer payant |
| **Bloque** | Rien (Google + Email/Password fonctionnent) |

---

## Description

Configurer Apple Sign-In pour permettre la connexion via compte Apple.

**Prerequis:** Compte Apple Developer payant (99$/an)

Le code Flutter est deja implemente (`sign_in_with_apple`), il reste uniquement la configuration.

---

## Etapes de configuration

### Etape 1: Apple Developer Portal

1. Aller sur [developer.apple.com](https://developer.apple.com)
2. Se connecter avec le compte Apple Developer **payant**
3. Aller dans **Certificates, Identifiers & Profiles**

#### 1.1 Configurer l'App ID

1. Cliquer sur **Identifiers** dans le menu gauche
2. Trouver l'App ID `com.astblitz.app` (ou le creer si inexistant)
3. Cliquer dessus pour l'editer
4. Dans la liste des capabilities, cocher **Sign In with Apple**
5. Cliquer **Configure** a cote de Sign In with Apple
6. Selectionner **Enable as a primary App ID**
7. Sauvegarder

#### 1.2 Creer un Service ID (pour Web/Android si besoin)

> Note: Cette etape n'est necessaire que si on veut Apple Sign-In sur Web ou Android.

1. **Identifiers** → clic sur **+**
2. Selectionner **Services IDs** → Continue
3. Description: `AST Blitz Sign In`
4. Identifier: `com.astblitz.app.signin`
5. Cocher **Sign In with Apple** → Configure
6. Primary App ID: selectionner `com.astblitz.app`
7. Domains: `astblitz.firebaseapp.com` (ou ton domaine)
8. Return URLs: `https://astblitz.firebaseapp.com/__/auth/handler`
9. Sauvegarder

#### 1.3 Creer une Key pour les notifications (optionnel)

> Pour recevoir les revocations de tokens Apple.

1. **Keys** → clic sur **+**
2. Key Name: `AST Blitz Apple Sign In`
3. Cocher **Sign In with Apple** → Configure
4. Primary App ID: `com.astblitz.app`
5. Sauvegarder et **telecharger la key** (fichier .p8)
6. Noter le **Key ID** affiche

---

### Etape 2: Configuration Xcode

1. Ouvrir le projet dans Xcode:
   ```bash
   open ios/Runner.xcworkspace
   ```

2. Dans le navigateur, selectionner **Runner** (icone bleue)

3. Onglet **Signing & Capabilities**

4. Verifier que le **Team** est bien selectionne (ton compte Apple Developer)

5. Cliquer sur **+ Capability** (bouton en haut a gauche)

6. Chercher et ajouter **Sign In with Apple**

7. La capability apparait dans la liste

8. Fermer Xcode

---

### Etape 3: Configuration Firebase

1. Aller sur [Firebase Console](https://console.firebase.google.com)

2. Selectionner le projet **AST Blitz**

3. Menu gauche: **Authentication** → **Sign-in method**

4. Cliquer sur **Apple** dans la liste des providers

5. Activer le toggle **Enable**

6. Configuration:
   - **Services ID**: `com.astblitz.app` (ou le Service ID cree)
   - **Apple Team ID**: Trouve dans Apple Developer → Membership
   - **Key ID**: L'ID de la key creee a l'etape 1.3
   - **Private Key**: Coller le contenu du fichier .p8

7. Sauvegarder

---

### Etape 4: Test

1. Lancer l'app sur un device iOS physique (pas simulateur)
   ```bash
   flutter run
   ```

2. Aller sur l'ecran de login

3. Cliquer sur **Continuer avec Apple**

4. Suivre le flow Apple (Face ID / Touch ID / Password)

5. Verifier dans Firebase Console → Authentication → Users que l'utilisateur est cree

---

## Troubleshooting

### Erreur 1000 (AuthorizationError)

```
The operation couldn't be completed.
(com.apple.AuthenticationServices.AuthorizationError error 1000.)
```

**Causes possibles:**
- Capability "Sign In with Apple" non ajoutee dans Xcode
- App ID non configure dans Apple Developer Portal
- Team ID incorrect dans Xcode

### Erreur 1001 (Cancelled)

L'utilisateur a annule le flow - comportement normal.

### Erreur sur simulateur

Apple Sign-In ne fonctionne **que sur device physique**, pas sur simulateur.

---

## Fichiers concernes

Le code est deja en place:

```
lib/
├── data/repositories/auth_repository.dart     # signInWithApple()
├── presentation/
│   ├── providers/auth_provider.dart           # signInWithApple()
│   └── screens/auth/
│       ├── login_screen.dart                  # Bouton Apple (cache pour l'instant)
│       └── widgets/social_login_button.dart   # SocialLoginType.apple
```

---

## Criteres de completion

- [ ] Compte Apple Developer payant actif
- [ ] App ID configure avec Sign In with Apple
- [ ] Capability ajoutee dans Xcode
- [ ] Firebase configure avec Apple provider
- [ ] Test OK sur device physique iOS
- [ ] Bouton Apple reactive dans l'UI

---

## Liens utiles

- [Apple Developer Portal](https://developer.apple.com)
- [Firebase Apple Auth Doc](https://firebase.google.com/docs/auth/ios/apple)
- [sign_in_with_apple package](https://pub.dev/packages/sign_in_with_apple)
- [Apple Human Interface Guidelines - Sign In with Apple](https://developer.apple.com/design/human-interface-guidelines/sign-in-with-apple)

---

## Notes

- **Cout**: 99$/an pour le compte Apple Developer
- **Delai**: Configuration ~30 min une fois le compte actif
- **Alternative**: En attendant, Google Sign-In et Email/Password fonctionnent
